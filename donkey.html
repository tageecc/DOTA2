<!DOCTYPE html>

<html>

<head>
    <title>信使</title>
    <script src="libs/three.js/build/three.min.js"></script>
    <script src="libs/three.js/examples/js/objects/Water.js"></script>
    <script src="libs/three.js/examples/js/controls/OrbitControls.js"></script>
    <script src="libs/three.js/examples/js/loaders/OBJLoader.js"></script>
    <script src="libs/three.js/examples/js/loaders/MTLLoader.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
<div id="3d"></div>

<script type="text/javascript">
    var render, scene, camera,light,water,cubeMap;

    var parameters = {
        oceanSide: 2000,
        size: 1.0,
        distortionScale: 3.7,
        alpha: 1.0
    };

    init();

    function initRender() {
        render = new THREE.WebGLRenderer();
        render.setSize(window.innerWidth, window.innerHeight);
        render.setPixelRatio( window.devicePixelRatio );
        render.shadowMapEnabled = true;
        document.getElementById('3d').append(render.domElement);
    }

    function initScene() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2( '#ccc', 0.0005 );


    }

    function initCamera() {
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.set( 100, 200, 500 );
    }
    function initLight() {
        light = new THREE.DirectionalLight( 0xffffbb, 1 );
        light.position.set( - 30, 30, - 30 );
        light.castShadow = true;
        light.shadow.camera.top = 45;
        light.shadow.camera.right = 40;
        light.shadow.camera.left = light.shadow.camera.bottom = -40;
        light.shadow.camera.near = 1;
        light.shadow.camera.far = 200;

        scene.add( light, new THREE.AmbientLight( 0x888888 ) );

        // 添加环境光
        scene.add(new THREE.AmbientLight('#fff'));

    }
    function initControl() {
        var controls = new THREE.OrbitControls(camera, render.domElement);
        controls.maxPolarAngle = Math.PI * 0.495;
        controls.target.set(0, 10, 0);
        controls.enablePan = false;
        controls.minDistance = 40.0;
        controls.maxDistance = 600.0;
        camera.lookAt(controls.target);
    }

    function loadModule() {
        var loader = new THREE.OBJLoader();
        loader.load('3DMod/courier/models/props_gameplay/OBJ/donkey_wings.obj', function (geometry) {
            var material = new THREE.MeshLambertMaterial({color: 0x5C3A21});

            geometry.position.set(0, 0, 0);
            geometry.traverse(function (child) {
                if (child instanceof THREE.Mesh) {
                    child.material.map = THREE.ImageUtils.loadTexture('3DMod/courier/materialsrc/models/props_gameplay/donkey01.jpg');
                    child.material.needsUpdate = true;
                }
            });

            geometry.children.forEach(function (child) {
                if (child.children.length === 1) {
                    if (child.children[0] instanceof THREE.Mesh) {
                        child.children[0].material = material;
                    }
                }
            });

            scene.add(geometry);
        });


    }
    function loadSkyBox() {

        cubeMap = new THREE.CubeTexture( [] );
        cubeMap.format = THREE.RGBFormat;

        var loader = new THREE.ImageLoader();
        loader.load( 'libs/three.js/examples/textures/skyboxsun25degtest.png', function ( image ) {

            var getSide = function ( x, y ) {

                var size = 1024;

                var canvas = document.createElement( 'canvas' );
                canvas.width = size;
                canvas.height = size;

                var context = canvas.getContext( '2d' );
                context.drawImage( image, - x * size, - y * size );

                return canvas;

            };

            cubeMap.images[ 0 ] = getSide( 2, 1 ); // px
            cubeMap.images[ 1 ] = getSide( 0, 1 ); // nx
            cubeMap.images[ 2 ] = getSide( 1, 0 ); // py
            cubeMap.images[ 3 ] = getSide( 1, 2 ); // ny
            cubeMap.images[ 4 ] = getSide( 1, 1 ); // pz
            cubeMap.images[ 5 ] = getSide( 3, 1 ); // nz
            cubeMap.needsUpdate = true;

        } );

        var cubeShader = THREE.ShaderLib[ 'cube' ];
        cubeShader.uniforms[ 'tCube' ].value = cubeMap;

        var skyBoxMaterial = new THREE.ShaderMaterial( {
            fragmentShader: cubeShader.fragmentShader,
            vertexShader: cubeShader.vertexShader,
            uniforms: cubeShader.uniforms,
            side: THREE.BackSide
        } );

        var skyBox = new THREE.Mesh(
            new THREE.BoxGeometry( parameters.oceanSide * 5 + 100, parameters.oceanSide * 5 + 100, parameters.oceanSide * 5 + 100 ),
            skyBoxMaterial
        );

        scene.add( skyBox );

    }
    function loadWater() {

        water = new THREE.Water(
            parameters.oceanSide * 5,
            parameters.oceanSide * 5,
            {
                textureWidth: 512,
                textureHeight: 512,
                waterNormals: new THREE.TextureLoader().load( 'libs/three.js/examples/textures/waternormals.jpg', function ( texture ) {
                    texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                }),
                alpha: 	parameters.alpha,
                sunDirection: light.position.clone().normalize(),
                sunColor: 0xffffff,
                waterColor: 0x001e0f,
                distortionScale: parameters.distortionScale,
                fog: scene.fog !== undefined
            }
        );
        water.rotation.x = - Math.PI / 2;
        water.receiveShadow = true;

        scene.add( water );

    }

    function init() {
        initRender();
        initScene();
        initCamera();
        initLight();
        initControl();

        loadSkyBox();
        loadWater();
        loadModule();

        renderAni()
    }

    function renderAni() {
        requestAnimationFrame(renderAni);

        water.material.uniforms.time.value += 1.0 / 60.0;
        water.material.uniforms.size.value = parameters.size;
        water.material.uniforms.distortionScale.value = parameters.distortionScale;
        water.material.uniforms.alpha.value = parameters.alpha;
        render.render(scene, camera);
    }

</script>
</body>
</html>